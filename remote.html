<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4CAF50">
    <title>Puzzel Remote - Ouder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            min-height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 22px;
            color: #333;
            margin-bottom: 8px;
        }

        h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Connect Screen */
        .code-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .code-digit {
            width: 50px;
            height: 60px;
            font-size: 28px;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 12px;
            font-weight: bold;
            color: #333;
        }

        .code-digit:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .connect-btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .connect-btn:active {
            transform: scale(0.98);
        }

        .connect-btn:disabled {
            background: #ccc;
            box-shadow: none;
        }

        .error-msg {
            color: #f44336;
            font-size: 14px;
            margin-top: 15px;
            display: none;
        }

        /* Connected Screen */
        .connected-screen {
            display: none;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            color: #4CAF50;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Puzzle Preview */
        .puzzle-preview {
            background: #f0f0f0;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .puzzle-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: #666;
        }

        .puzzle-preview-header .puzzle-name {
            font-weight: 600;
            color: #333;
        }

        .puzzle-preview-canvas {
            width: 100%;
            aspect-ratio: 8/5;
            border-radius: 8px;
            background: #333;
            object-fit: contain;
        }

        .puzzle-preview-img {
            width: 100%;
            border-radius: 8px;
            background: #333;
        }

        .puzzle-progress-bar {
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .puzzle-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        /* Celebration overlay in remote */
        .puzzle-complete-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            animation: celebratePop 0.5s ease;
        }

        @keyframes celebratePop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }


        /* Navigation Buttons - Clean tile style */
        .nav-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .nav-btn {
            width: 100%;
            padding: 16px 10px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            border-radius: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .nav-btn .icon {
            font-size: 26px;
        }

        .nav-btn .label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        .nav-btn:active {
            transform: scale(0.97);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        /* Primary action button */
        .nav-btn.primary {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .nav-btn.primary .label {
            color: white;
        }

        .nav-btn.primary.success {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Secondary buttons */
        .nav-btn.secondary {
            background: white;
        }

        .nav-btn.secondary:hover {
            background: #fafafa;
        }

        /* Active state for pause button */
        .nav-btn.secondary.active {
            background: #fff3e0;
            border: 2px solid #FF9800;
        }

        .nav-btn.secondary.active .label {
            color: #E65100;
        }

        /* Library Screen (Puzzelbieb) */
        .library-screen {
            display: none;
        }

        .library-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 4px;
        }

        .library-tab {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .library-tab.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .library-content {
            min-height: 200px;
        }

        /* Photo crop modal */
        .photo-crop-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Photo Screen (legacy, now part of library) */
        .photo-screen {
            display: none;
        }

        .photo-preview-container {
            margin-bottom: 15px;
        }

        .crop-area {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            touch-action: none;
        }

        #photo-preview {
            width: 100%;
            display: block;
            opacity: 0.4;
        }

        .crop-box {
            position: absolute;
            border: 3px solid #4CAF50;
            box-sizing: border-box;
            cursor: move;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .crop-box::after {
            content: '‚ÜîÔ∏è Sleep om te verplaatsen';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 4px 10px;
            border-radius: 10px;
            white-space: nowrap;
        }

        .crop-hint {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin: 8px 0;
        }

        /* Photo Library */
        .photo-library {
            margin: 15px 0;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .library-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .library-count {
            font-size: 12px;
            color: #666;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 8/5;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .photo-item:hover {
            border-color: #4CAF50;
            transform: scale(1.02);
        }

        .photo-item.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .photo-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 3px 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-item .delete-photo {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .photo-item:hover .delete-photo {
            display: flex;
        }

        .empty-library {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .empty-library-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .photo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-actions button {
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .add-photo-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
        }

        .use-selected-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            border: none;
        }

        .use-selected-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Queue styles */

        .queue-screen {
            display: none;
        }

        .queue-info {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .queue-info .current-puzzle {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .queue-info .queue-status {
            font-size: 18px;
            font-weight: bold;
            color: #9C27B0;
        }

        .queue-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .queue-item.current {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .queue-item-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #9C27B0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .queue-item.current .queue-item-number {
            background: #4CAF50;
        }

        .queue-item-thumb {
            width: 64px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: #ddd;
            flex-shrink: 0;
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-type {
            font-size: 11px;
            color: #999;
        }

        .queue-item-remove {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #ffebee;
            color: #f44336;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .queue-empty {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .queue-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .queue-actions button {
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .add-to-queue-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
        }

        .add-photo-queue-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }

        .next-puzzle-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            padding: 15px;
            font-size: 16px;
        }

        .next-puzzle-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auto-next-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .auto-next-toggle span {
            font-size: 14px;
        }

        .disconnect-btn {
            margin-top: 10px;
            padding: 12px 25px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            color: #666;
            cursor: pointer;
        }

        /* Settings Screen */
        .settings-screen {
            display: none;
        }

        /* Age selector */
        .age-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .age-btn {
            padding: 10px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .age-btn.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .age-btn:active {
            transform: scale(0.95);
        }

        /* Task management */
        .task-manage-screen {
            display: none;
        }

        .task-manage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .task-manage-actions {
            display: flex;
            gap: 8px;
        }

        .task-manage-actions button {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            border: none;
            cursor: pointer;
        }

        .reset-tasks-btn {
            background: #ff9800;
            color: white;
        }

        .add-task-btn {
            background: #4CAF50;
            color: white;
        }

        .task-manage-list {
            max-height: 55vh;
            overflow-y: auto;
        }

        .task-manage-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .task-manage-item.disabled {
            opacity: 0.5;
        }

        .task-manage-item .task-toggle {
            flex-shrink: 0;
        }

        .task-manage-item .task-text {
            flex: 1;
            font-size: 13px;
        }

        .task-manage-item .task-delete {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: #ffebee;
            color: #f44336;
            cursor: pointer;
            font-size: 14px;
        }

        .task-manage-item.custom {
            border-color: #4CAF50;
            background: #f1f8e9;
        }

        /* Add task modal */
        .add-task-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .add-task-modal.show {
            display: flex;
        }

        .add-task-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 350px;
        }

        .add-task-content h3 {
            margin: 0 0 15px 0;
            text-align: center;
        }

        .add-task-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .add-task-content input:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .add-task-buttons {
            display: flex;
            gap: 10px;
        }

        .add-task-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .add-task-cancel {
            background: #eee;
            color: #666;
        }

        .add-task-save {
            background: #4CAF50;
            color: white;
        }

        /* Compact Setting Row */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .setting-value {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Dropdown selector button */
        .setting-select {
            padding: 8px 12px;
            font-size: 13px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }

        /* Mini color buttons in row */
        .color-row {
            display: flex;
            gap: 6px;
        }

        .color-btn-mini {
            width: 28px;
            height: 28px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn-mini.selected {
            border-color: #333;
            transform: scale(1.15);
        }

        /* Mini vehicle buttons */
        .vehicle-row {
            display: flex;
            gap: 4px;
        }

        .vehicle-btn-mini {
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            border-radius: 6px;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vehicle-btn-mini.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        /* Timer stepper */
        .timer-stepper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer-stepper button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .timer-stepper span {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
        }

        /* Settings footer */
        .settings-footer {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .settings-footer .save-btn {
            flex: 3;
        }

        .settings-footer .back-btn {
            flex: 1;
            padding: 12px 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .slider-toggle:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider-toggle {
            background-color: #4CAF50;
        }

        input:checked + .slider-toggle:before {
            transform: translateX(24px);
        }

        /* Vehicle Grid */
        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .vehicle-btn {
            padding: 12px;
            font-size: 24px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
        }

        .vehicle-btn:active {
            transform: scale(0.95);
        }

        .vehicle-btn.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        /* Settings Footer */
        .settings-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .save-btn {
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            cursor: pointer;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            padding: 15px 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.reset { background: #f44336; }
        .action-btn.next { background: #2196F3; }
        .action-btn.pause { background: #FF9800; }
        .action-btn.resume { background: #4CAF50; }

        /* Tasks Screen - Compact Bucketlist Style */
        .tasks-screen {
            display: none;
        }

        .tasks-screen h2 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .tasks-screen .subtitle {
            font-size: 12px;
            margin-bottom: 12px;
        }

        .task-categories {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .category {
            margin-bottom: 8px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            padding: 8px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .category-header:active {
            opacity: 0.9;
        }

        .category-header .toggle-icon {
            transition: transform 0.2s;
        }

        .category.open .toggle-icon {
            transform: rotate(180deg);
        }

        .category-tasks {
            display: none;
            padding: 4px 0;
        }

        .category.open .category-tasks {
            display: block;
        }

        /* Compact task items with checkboxes */
        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            background: white;
            color: #333;
            cursor: pointer;
            text-align: left;
            width: 100%;
            margin: 2px 0;
            transition: all 0.15s;
        }

        .task-item:active {
            background: #e8f5e9;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.15s;
        }

        .task-item.completed .task-checkbox {
            background: #4CAF50;
            border-color: #4CAF50;
            color: white;
        }

        .task-item.completed {
            background: #e8f5e9;
            color: #888;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
        }

        .task-text {
            flex: 1;
            line-height: 1.3;
        }

        .task-item.flash {
            animation: taskFlash 0.4s ease;
        }

        @keyframes taskFlash {
            0% { background: #4CAF50; color: white; }
            100% { background: white; color: #333; }
        }

        /* Completed counter per category */
        .category-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: normal;
        }

        /* Puzzles Screen */
        .puzzles-screen {
            display: none;
        }

        .puzzle-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .puzzle-item {
            padding: 15px 10px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            text-align: center;
        }

        .puzzle-item:active {
            transform: scale(0.95);
        }

        .puzzle-item .emoji {
            font-size: 28px;
            display: block;
            margin-bottom: 5px;
        }

        /* Back Button */
        .back-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            color: #666;
            cursor: pointer;
        }

        .back-btn:active {
            background: #f5f5f5;
        }

        .instructions {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .instructions strong {
            color: #333;
        }

        .version-info {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }

        /* Tutorial/Onboarding Overlay */
        .tutorial-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tutorial-overlay.show {
            display: flex;
        }

        .tutorial-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 340px;
            width: 100%;
            text-align: center;
            animation: tutorialSlideIn 0.3s ease;
        }

        @keyframes tutorialSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tutorial-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .tutorial-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .tutorial-text {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .tutorial-progress {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 20px;
        }

        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.2s;
        }

        .tutorial-dot.active {
            background: #4CAF50;
            transform: scale(1.2);
        }

        .tutorial-buttons {
            display: flex;
            gap: 10px;
        }

        .tutorial-btn {
            flex: 1;
            padding: 14px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tutorial-btn.skip {
            background: #f5f5f5;
            color: #666;
        }

        .tutorial-btn.next {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
        }

        .tutorial-btn:active {
            transform: scale(0.97);
        }

        .tutorial-highlight {
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.5);
            position: relative;
            z-index: 2001;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Connect Screen -->
        <div class="card connect-screen" id="connect-screen">
            <h1>üéÆ Puzzel Remote</h1>
            <p class="subtitle">Verbind met de tablet van je kind</p>

            <div class="code-input-container">
                <input type="tel" class="code-digit" maxlength="1" id="digit1" inputmode="numeric" pattern="[0-9]">
                <input type="tel" class="code-digit" maxlength="1" id="digit2" inputmode="numeric" pattern="[0-9]">
                <input type="tel" class="code-digit" maxlength="1" id="digit3" inputmode="numeric" pattern="[0-9]">
                <input type="tel" class="code-digit" maxlength="1" id="digit4" inputmode="numeric" pattern="[0-9]">
            </div>

            <button class="connect-btn" id="connect-btn" disabled>Verbinden</button>

            <p class="error-msg" id="error-msg"></p>

            <div class="instructions">
                <strong>Hoe werkt het?</strong><br>
                1. Open de app op de tablet<br>
                2. Lees de code linksonder op het tablet scherm<br>
                3. Voer de 4-cijferige code hier in
            </div>
        </div>

        <!-- Connected Screen (Main Menu) -->
        <div class="card connected-screen" id="connected-screen">
            <div class="status">
                <div class="status-dot"></div>
                <span>Verbonden met tablet</span>
            </div>

            <!-- Puzzle Preview -->
            <div class="puzzle-preview" id="puzzle-preview">
                <div class="puzzle-preview-header">
                    <span id="preview-progress-text">0/40</span>
                </div>
                <img class="puzzle-preview-img" id="preview-img" src="" alt="Puzzel preview">
                <div class="puzzle-progress-bar">
                    <div class="puzzle-progress-fill" id="preview-progress-fill" style="width: 0%"></div>
                </div>
                <div class="puzzle-complete-badge" id="puzzle-complete-badge">üéâ Puzzel Af!</div>
            </div>

            <!-- Row 1: Piece + Bucketlist -->
            <div class="nav-grid">
                <button class="nav-btn primary" id="piece-btn">
                    <span class="icon">üß©</span>
                    <span class="label">Stukje geven</span>
                </button>
                <button class="nav-btn secondary" id="show-tasks-btn">
                    <span class="icon">‚úÖ</span>
                    <span class="label">Bucketlist</span>
                </button>
            </div>

            <!-- Row 2: Puzzelbieb + Wachtrij -->
            <div class="nav-grid">
                <button class="nav-btn secondary" id="show-library-btn">
                    <span class="icon">üñºÔ∏è</span>
                    <span class="label">Puzzelbieb</span>
                </button>
                <button class="nav-btn secondary" id="show-queue-btn">
                    <span class="icon">üìö</span>
                    <span class="label">Wachtrij</span>
                </button>
            </div>

            <!-- Row 3: Pause + Settings -->
            <div class="nav-grid">
                <button class="nav-btn secondary" id="pause-btn">
                    <span class="icon">‚è∏Ô∏è</span>
                    <span class="label">Pauzeer</span>
                </button>
                <button class="nav-btn secondary" id="show-settings-btn">
                    <span class="icon">‚öôÔ∏è</span>
                    <span class="label">Instellingen</span>
                </button>
            </div>
        </div>

        <!-- Queue Screen -->
        <div class="card queue-screen" id="queue-screen">
            <h2>üìã Puzzel Wachtrij</h2>
            <p class="subtitle">Beheer de volgorde van puzzels</p>

            <div class="queue-info">
                <div class="current-puzzle">Huidige puzzel: <span id="queue-current-name">-</span></div>
                <div class="queue-status"><span id="queue-count">0</span> puzzels in wachtrij</div>
            </div>

            <div class="queue-list" id="queue-list">
                <!-- Queue items will be inserted here -->
            </div>
            <div class="queue-empty" id="queue-empty">
                <div style="font-size: 40px; margin-bottom: 10px;">üì≠</div>
                <p>Wachtrij is leeg.<br>Voeg puzzels toe!</p>
            </div>

            <div class="queue-actions">
                <button class="add-to-queue-btn" id="add-puzzle-to-queue-btn">üß© Standaard puzzel</button>
                <button class="add-photo-queue-btn" id="add-photo-to-queue-btn">üì∑ Eigen foto</button>
            </div>

            <button class="next-puzzle-btn" id="load-next-btn" disabled>‚ñ∂Ô∏è Volgende puzzel laden</button>

            <button class="back-btn" id="queue-back-btn" style="margin-top: 10px;">‚Üê Terug</button>
        </div>


        <!-- Settings Screen -->
        <div class="card settings-screen" id="settings-screen">
            <h2>‚öôÔ∏è Instellingen</h2>

            <div class="setting-row">
                <span class="setting-label">üë∂ Leeftijd</span>
                <select class="setting-select" id="age-select">
                    <option value="1">1 jaar</option>
                    <option value="2" selected>2 jaar</option>
                    <option value="3">3 jaar</option>
                    <option value="4">4 jaar</option>
                    <option value="5">5+ jaar</option>
                </select>
            </div>

            <div class="setting-row">
                <span class="setting-label">‚è±Ô∏è Min/stukje</span>
                <div class="timer-stepper">
                    <button id="timer-minus">‚àí</button>
                    <span id="timer-value">15</span>
                    <button id="timer-plus">+</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">üß© Stukjes</span>
                <select class="setting-select" id="piece-count">
                    <option value="4">4</option>
                    <option value="12">12</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="40" selected>40</option>
                    <option value="60">60</option>
                </select>
            </div>

            <div class="setting-row">
                <span class="setting-label">üéØ Leggen</span>
                <select class="setting-select" id="puzzle-mode">
                    <option value="auto">Automatisch</option>
                    <option value="manual">Zelf slepen</option>
                </select>
            </div>

            <div class="setting-row">
                <span class="setting-label">üé® Kleur</span>
                <div class="color-row" id="color-grid">
                    <button class="color-btn-mini selected" data-color="ocean" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)"></button>
                    <button class="color-btn-mini" data-color="sunset" style="background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%)"></button>
                    <button class="color-btn-mini" data-color="forest" style="background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)"></button>
                    <button class="color-btn-mini" data-color="sunshine" style="background:linear-gradient(135deg,#F7971E 0%,#FFD200 100%)"></button>
                    <button class="color-btn-mini" data-color="night" style="background:linear-gradient(135deg,#0f0c29 0%,#302b63 50%,#24243e 100%)"></button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">üöó Voertuig</span>
                <div class="vehicle-row" id="vehicle-grid">
                    <button class="vehicle-btn-mini selected" data-vehicle="üèçÔ∏è">üèçÔ∏è</button>
                    <button class="vehicle-btn-mini" data-vehicle="üöú">üöú</button>
                    <button class="vehicle-btn-mini" data-vehicle="‚úàÔ∏è">‚úàÔ∏è</button>
                    <button class="vehicle-btn-mini" data-vehicle="üöÄ">üöÄ</button>
                    <button class="vehicle-btn-mini" data-vehicle="üöÅ">üöÅ</button>
                    <button class="vehicle-btn-mini" data-vehicle="üö§">üö§</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">üìã Bucketlist</span>
                <button class="setting-select" id="manage-tasks-btn" style="background:#4CAF50;color:white;border:none;">
                    Beheren
                </button>
            </div>

            <div class="setting-row" style="border-bottom:none;">
                <span class="setting-label">‚ùì Uitleg</span>
                <button class="setting-select" id="start-tutorial-btn" style="background:#2196F3;color:white;border:none;">
                    Tutorial
                </button>
            </div>

            <div class="settings-footer">
                <button class="save-btn" id="settings-save-btn">‚úì Opslaan</button>
                <button class="back-btn" id="settings-back-btn">‚Üê</button>
            </div>
        </div>

        <!-- Tasks Screen -->
        <div class="card tasks-screen" id="tasks-screen">
            <h2>üìã Bucketlist</h2>
            <p class="subtitle">Tik op een taak als je kind het heeft gedaan</p>

            <div class="task-categories" id="task-categories">
                <!-- Categories will be populated by JS -->
            </div>

            <button class="back-btn" id="tasks-back-btn">‚Üê Terug</button>
        </div>

        <!-- Task Management Screen -->
        <div class="card task-manage-screen" id="task-manage-screen">
            <h2>‚úèÔ∏è Taken Beheren</h2>
            <p class="subtitle">Schakel taken in/uit of voeg eigen taken toe</p>

            <div class="task-manage-header">
                <span id="active-task-count">0 actief</span>
                <div class="task-manage-actions">
                    <button class="reset-tasks-btn" id="reset-tasks-btn">üîÑ Reset</button>
                    <button class="add-task-btn" id="add-custom-task-btn">‚ûï Nieuw</button>
                </div>
            </div>

            <div class="task-manage-list" id="task-manage-list">
                <!-- Tasks will be populated by JS -->
            </div>

            <button class="back-btn" id="task-manage-back-btn">‚Üê Terug</button>
        </div>

        <!-- Add Task Modal -->
        <div class="add-task-modal" id="add-task-modal">
            <div class="add-task-content">
                <h3>‚ûï Nieuwe Taak</h3>
                <input type="text" id="new-task-input" placeholder="Bijv: üéà Een ballon gezien" maxlength="50">
                <select id="new-task-category" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:14px;margin-bottom:15px;">
                    <option value="üéµ Geluiden & Muziek">üéµ Geluiden & Muziek</option>
                    <option value="üëÄ Onderweg Spotten">üëÄ Onderweg Spotten</option>
                    <option value="üêæ Dieren Spotten">üêæ Dieren Spotten</option>
                    <option value="üåà Natuur & Weer">üåà Natuur & Weer</option>
                    <option value="ü§∏ Beweging & Spel">ü§∏ Beweging & Spel</option>
                    <option value="üß† Slim & Leerzaam">üß† Slim & Leerzaam</option>
                    <option value="üçé Eten & Drinken">üçé Eten & Drinken</option>
                    <option value="üòä Goed Gedrag">üòä Goed Gedrag</option>
                    <option value="üè† Gebouwen Spotten">üè† Gebouwen Spotten</option>
                </select>
                <div class="add-task-buttons">
                    <button class="add-task-cancel" id="cancel-new-task">Annuleren</button>
                    <button class="add-task-save" id="save-new-task">Toevoegen</button>
                </div>
            </div>
        </div>

        <!-- Puzzelbieb Screen (combined puzzles + photos) -->
        <div class="card library-screen" id="library-screen">
            <h2>üñºÔ∏è Puzzelbieb</h2>

            <!-- Tab selector -->
            <div class="library-tabs">
                <button class="library-tab active" data-tab="presets">üß© Preset puzzels</button>
                <button class="library-tab" data-tab="photos">üì∑ Mijn foto's</button>
            </div>

            <!-- Preset puzzles tab -->
            <div class="library-content" id="presets-tab">
                <div class="puzzle-grid" id="puzzle-grid">
                    <!-- Puzzles will be populated by JS -->
                </div>
            </div>

            <!-- My photos tab -->
            <div class="library-content" id="photos-tab" style="display:none;">
                <input type="file" id="photo-input" accept="image/*" style="display:none">

                <div id="photo-grid" class="photo-grid">
                    <!-- Photos will be inserted here -->
                </div>
                <div class="empty-library" id="empty-library">
                    <div class="empty-library-icon">üì∑</div>
                    <p>Nog geen foto's.<br>Tik op + om een foto toe te voegen</p>
                </div>

                <div class="photo-actions" style="margin-top:10px;">
                    <button class="add-photo-btn" id="add-photo-btn">‚ûï Foto toevoegen</button>
                    <button class="use-selected-btn" id="use-selected-btn" disabled>‚ñ∂Ô∏è Gebruik</button>
                </div>
            </div>

            <button class="back-btn" id="library-back-btn" style="margin-top: 10px;">‚Üê Terug</button>
        </div>

        <!-- Photo crop modal -->
        <div class="photo-crop-modal" id="photo-crop-modal" style="display:none;">
            <div class="card" style="margin:20px;max-width:400px;">
                <h2>üì∑ Foto bijsnijden</h2>
                <div class="crop-area" id="crop-area">
                    <img id="photo-preview" src="">
                    <div class="crop-box" id="crop-box"></div>
                </div>
                <p class="crop-hint">Sleep het groene kader naar het gewenste deel</p>
                <div class="photo-actions">
                    <button class="back-btn" id="cancel-photo-btn">‚úï Annuleren</button>
                    <button class="save-btn" id="save-to-library-btn">üíæ Opslaan</button>
                </div>
            </div>
        </div>

        <!-- Tutorial Overlay -->
        <div class="tutorial-overlay" id="tutorial-overlay">
            <div class="tutorial-card">
                <div class="tutorial-icon" id="tutorial-icon">üéÆ</div>
                <div class="tutorial-title" id="tutorial-title">Welkom!</div>
                <div class="tutorial-text" id="tutorial-text">Leer hoe je de puzzel app bedient.</div>
                <div class="tutorial-progress" id="tutorial-progress">
                    <!-- Dots will be added by JS -->
                </div>
                <div class="tutorial-buttons">
                    <button class="tutorial-btn skip" id="tutorial-skip">Overslaan</button>
                    <button class="tutorial-btn next" id="tutorial-next">Volgende</button>
                </div>
            </div>
        </div>

        <div class="version-info">v2.11.1</div>
    </div>

    <script src="src/js/storage.js"></script>
    <script src="src/js/firebase-config.js"></script>
    <script src="src/js/remote.js"></script>
    <script>
        // Diverse bucketlist taken per categorie
        const remoteTasks = {
            "üéµ Geluiden & Muziek": [
                "üéµ Een liedje gezongen",
                "üëè In de handen geklapt",
                "üêÆ Koe-geluid gemaakt",
                "üê∑ Varken-geluid gemaakt",
                "üê∂ Hond-geluid gemaakt",
                "üê± Kat-geluid gemaakt",
                "ü¶Å Leeuw-geluid gemaakt",
                "üê∏ Kikker-geluid gemaakt",
                "üê¶ Vogel-geluid gemaakt",
                "üöó Auto-geluid gemaakt",
                "üöÇ Trein-geluid gemaakt",
                "üêù Bij-geluid gemaakt",
                "üêç Slang-geluid gemaakt",
                "ü¶Ü Eend-geluid gemaakt",
                "üé§ ABC-liedje gezongen"
            ],
            "üëÄ Onderweg Spotten": [
                "üöó Rode auto gezien",
                "üöô Blauwe auto gezien",
                "üöï Gele auto gezien",
                "‚ö™ Witte auto gezien",
                "‚ö´ Zwarte auto gezien",
                "üöö Vrachtwagen gezien",
                "üöå Bus gezien",
                "üöí Brandweerauto gezien",
                "üöë Ambulance gezien",
                "üöì Politieauto gezien",
                "üöú Tractor gezien",
                "üèçÔ∏è Motor gezien",
                "üö≤ Fiets gezien",
                "‚úàÔ∏è Vliegtuig gezien",
                "üöÅ Helikopter gezien",
                "‚õµ Boot gezien"
            ],
            "üêæ Dieren Spotten": [
                "üêÑ Koe gezien",
                "üêë Schaap gezien",
                "üê¥ Paard gezien",
                "üêê Geit gezien",
                "üê∑ Varken gezien",
                "ü¶Ü Eend gezien",
                "üê¶ Vogel gezien",
                "üêï Hond gezien",
                "üêà Kat gezien",
                "üêá Konijn gezien",
                "ü¶¢ Zwaan gezien",
                "üêì Haan/kip gezien"
            ],
            "üåà Natuur & Weer": [
                "üå≥ Grote boom gezien",
                "üå≤ Dennenboom gezien",
                "üíß Water gezien",
                "üåà Regenboog gezien",
                "‚òÄÔ∏è De zon gezien",
                "‚òÅÔ∏è Wolk aangewezen",
                "üåßÔ∏è Regen gezien",
                "üåæ Korenveld gezien",
                "üåª Bloemen gezien",
                "üçÇ Herfstbladeren gezien",
                "üèîÔ∏è Heuvels gezien",
                "üåÖ Mooie lucht gezien"
            ],
            "ü§∏ Beweging & Spel": [
                "üëã Gezwaaid naar iemand",
                "üëç Duimpje omhoog gedaan",
                "‚úã High five gegeven",
                "ü¶∂ Met voetjes gestampt",
                "üôÜ Armen omhoog gedaan",
                "üëÉ Neus aangeraakt",
                "üëÇ Oren aangeraakt",
                "üëÄ Ogen dichtgedaan",
                "ü§ó Knuffel gegeven",
                "üëê Handen open/dicht",
                "üôå Beide handen omhoog",
                "ü§ö Hand opgestoken"
            ],
            "üß† Slim & Leerzaam": [
                "üî¢ Tot 3 geteld",
                "‚úåÔ∏è 2 vingers laten zien",
                "üñêÔ∏è 5 vingers laten zien",
                "üî¥ Iets roods aangewezen",
                "üîµ Iets blauws aangewezen",
                "üü¢ Iets groens aangewezen",
                "üü° Iets geels aangewezen",
                "‚¨õ Iets zwarts aangewezen",
                "‚¨ú Iets wits aangewezen",
                "üü† Iets oranje aangewezen",
                "üü£ Iets paars aangewezen",
                "üî∑ Een vorm genoemd"
            ],
            "üçé Eten & Drinken": [
                "üßÉ Lekker gedronken",
                "üç™ Koekje gegeten",
                "üçé Fruit gegeten",
                "ü•™ Broodje gegeten",
                "üçå Banaan gegeten",
                "ü•ï Wortel gegeten",
                "üßÄ Kaas gegeten",
                "üçá Druiven gegeten"
            ],
            "üòä Goed Gedrag": [
                "üòä Lief gelachen",
                "ü§´ 5 minuten stil geweest",
                "ü™ë Rustig blijven zitten",
                "üë∂ Heel lief geweest",
                "üò¥ Even gerust",
                "üìñ Naar een boekje gekeken",
                "üß∏ Met knuffel gespeeld",
                "üé® Getekend of gekleurd",
                "üéß Rustig naar muziek geluisterd",
                "üß© Puzzel opgelost"
            ],
            "üè† Gebouwen Spotten": [
                "‚õ™ Kerk gezien",
                "üè´ School gezien",
                "üè• Ziekenhuis gezien",
                "üè™ Winkel gezien",
                "‚õΩ Tankstation gezien",
                "üè® Hotel gezien",
                "üè≠ Fabriek gezien",
                "üåâ Brug overgestoken",
                "üöè Bushalte gezien",
                "üöâ Treinstation gezien"
            ]
        };

        // Puzzle list (matching tablet)
        const puzzleList = [
            { name: 'Dierentuin', emoji: 'ü¶Å', color: '#87CEEB' },
            { name: 'Boerderij', emoji: 'üêÑ', color: '#87CEEB' },
            { name: 'Kermis', emoji: 'üé°', color: '#FF69B4' },
            { name: 'Onderwaterwereld', emoji: 'üê†', color: '#00CED1' },
            { name: 'Stad', emoji: 'üèôÔ∏è', color: '#87CEEB' },
            { name: 'Supermarkt', emoji: 'üõí', color: '#FFE4B5' },
            { name: 'Speeltuin', emoji: 'üõù', color: '#87CEEB' },
            { name: 'Bos', emoji: 'üå≤', color: '#228B22' },
            { name: 'Strand', emoji: 'üèñÔ∏è', color: '#87CEEB' },
            { name: 'Ruimte', emoji: 'üöÄ', color: '#000033' },
            { name: 'Feestje', emoji: 'üéÇ', color: '#FF69B4' },
            { name: 'Treinstation', emoji: 'üöÇ', color: '#87CEEB' },
            { name: 'Vliegveld', emoji: '‚úàÔ∏è', color: '#87CEEB' },
            { name: 'Camping', emoji: '‚õ∫', color: '#228B22' },
            { name: 'Sneeuwpret', emoji: '‚õ∑Ô∏è', color: '#B0E0E6' },
            { name: 'Jungle', emoji: 'ü¶ú', color: '#228B22' },
            { name: 'Circus', emoji: 'üé™', color: '#FF4500' },
            { name: 'Restaurant', emoji: 'üçï', color: '#FFDAB9' },
            { name: 'Muziek', emoji: 'üé∏', color: '#9370DB' },
            { name: 'Tuin', emoji: 'üå∑', color: '#87CEEB' },
            { name: 'Sportveld', emoji: '‚öΩ', color: '#228B22' },
            { name: 'Kasteel', emoji: 'üè∞', color: '#87CEEB' },
            { name: 'Piraten', emoji: 'üè¥‚Äç‚ò†Ô∏è', color: '#87CEEB' },
            { name: 'Bouwplaats', emoji: 'üèóÔ∏è', color: '#87CEEB' }
        ];
    </script>
    <script>
        // State
        let isPaused = false;
        let soundEnabled = true;

        // Elements
        const connectScreen = document.getElementById('connect-screen');
        const connectedScreen = document.getElementById('connected-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const tasksScreen = document.getElementById('tasks-screen');
        const libraryScreen = document.getElementById('library-screen');
        const queueScreen = document.getElementById('queue-screen');
        const taskManageScreen = document.getElementById('task-manage-screen');

        const connectBtn = document.getElementById('connect-btn');
        const errorMsg = document.getElementById('error-msg');
        const pieceBtn = document.getElementById('piece-btn');

        const digits = [
            document.getElementById('digit1'),
            document.getElementById('digit2'),
            document.getElementById('digit3'),
            document.getElementById('digit4')
        ];

        // Screen navigation
        function showScreen(screen) {
            connectScreen.style.display = 'none';
            connectedScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            tasksScreen.style.display = 'none';
            libraryScreen.style.display = 'none';
            queueScreen.style.display = 'none';
            taskManageScreen.style.display = 'none';
            screen.style.display = 'block';
        }

        // Track completed tasks per session
        const completedTasks = {};

        // Populate task categories with compact checkbox style
        function populateTaskCategories() {
            const container = document.getElementById('task-categories');
            container.innerHTML = '';

            for (const [categoryName, tasks] of Object.entries(remoteTasks)) {
                const categoryId = categoryName.replace(/\s/g, '_');
                completedTasks[categoryId] = completedTasks[categoryId] || new Set();

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.id = `cat-${categoryId}`;

                // Header with count
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.innerHTML = `
                    <span>${categoryName}</span>
                    <span>
                        <span class="category-count" id="count-${categoryId}">${completedTasks[categoryId].size}/${tasks.length}</span>
                        <span class="toggle-icon">‚ñº</span>
                    </span>
                `;

                const tasksDiv = document.createElement('div');
                tasksDiv.className = 'category-tasks';
                tasksDiv.id = `tasks-${categoryId}`;

                tasks.forEach((task, index) => {
                    const taskId = `${categoryId}-${index}`;
                    const isCompleted = completedTasks[categoryId].has(index);

                    const taskBtn = document.createElement('button');
                    taskBtn.className = `task-item${isCompleted ? ' completed' : ''}`;
                    taskBtn.id = taskId;
                    taskBtn.innerHTML = `
                        <span class="task-checkbox">${isCompleted ? '‚úì' : ''}</span>
                        <span class="task-text">${task}</span>
                    `;
                    taskBtn.addEventListener('click', () => toggleTask(taskBtn, categoryId, index, tasks.length));
                    tasksDiv.appendChild(taskBtn);
                });

                headerDiv.addEventListener('click', () => {
                    categoryDiv.classList.toggle('open');
                });

                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(tasksDiv);
                container.appendChild(categoryDiv);
            }

            // Open first category by default
            const firstCategory = container.querySelector('.category');
            if (firstCategory) firstCategory.classList.add('open');
        }

        // Toggle task completion and send piece
        async function toggleTask(btn, categoryId, taskIndex, totalTasks) {
            const wasCompleted = btn.classList.contains('completed');

            if (!wasCompleted) {
                // Mark as completed
                completedTasks[categoryId].add(taskIndex);
                btn.classList.add('completed');
                btn.querySelector('.task-checkbox').textContent = '‚úì';
                btn.classList.add('flash');
                setTimeout(() => btn.classList.remove('flash'), 400);

                // Send piece to tablet
                try {
                    await RemoteControl.sendPiece();
                } catch (error) {
                    console.error('Verzenden mislukt:', error);
                }
            } else {
                // Uncheck (no piece sent)
                completedTasks[categoryId].delete(taskIndex);
                btn.classList.remove('completed');
                btn.querySelector('.task-checkbox').textContent = '';
            }

            // Update count
            const countEl = document.getElementById(`count-${categoryId}`);
            if (countEl) {
                countEl.textContent = `${completedTasks[categoryId].size}/${totalTasks}`;
            }
        }

        // Populate puzzle grid
        function populatePuzzleGrid() {
            const container = document.getElementById('puzzle-grid');
            container.innerHTML = '';

            puzzleList.forEach((puzzle, index) => {
                const btn = document.createElement('button');
                btn.className = 'puzzle-item';
                btn.style.background = puzzle.color;
                btn.innerHTML = `<span class="emoji">${puzzle.emoji}</span>${puzzle.name}`;
                btn.addEventListener('click', () => selectPuzzle(index));
                container.appendChild(btn);
            });
        }

        // Send settings to tablet
        async function sendSettings(settings) {
            if (!RemoteControl.roomRef) {
                throw new Error('Niet verbonden');
            }

            await RemoteControl.roomRef.child('settings').update({
                ...settings,
                timestamp: Date.now()
            });
        }

        // Auto-focus and move between digits
        digits.forEach((digit, index) => {
            digit.addEventListener('input', (e) => {
                const value = e.target.value.replace(/\D/g, '');
                e.target.value = value.slice(-1);

                if (value && index < 3) {
                    digits[index + 1].focus();
                }

                updateConnectButton();
            });

            // Also listen to change and keyup for better compatibility
            digit.addEventListener('change', updateConnectButton);
            digit.addEventListener('keyup', updateConnectButton);

            digit.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    digits[index - 1].focus();
                }
            });

            digit.addEventListener('paste', (e) => {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const numbers = paste.replace(/\D/g, '').slice(0, 4);
                numbers.split('').forEach((num, i) => {
                    if (digits[i]) digits[i].value = num;
                });
                if (numbers.length === 4) digits[3].focus();
                updateConnectButton();
            });
        });

        function updateConnectButton() {
            const code = digits.map(d => d.value).join('');
            const shouldEnable = code.length === 4;
            connectBtn.disabled = !shouldEnable;
            console.log('updateConnectButton:', code, 'length:', code.length, 'enabled:', shouldEnable);
        }

        function getCode() {
            return digits.map(d => d.value).join('');
        }

        // Connect button
        connectBtn.addEventListener('click', async () => {
            const code = getCode();
            connectBtn.disabled = true;
            connectBtn.textContent = 'Verbinden...';
            errorMsg.style.display = 'none';

            try {
                await RemoteControl.joinRoom(code);
                showScreen(connectedScreen);
                populateTaskCategories();
                populatePuzzleGrid();
            } catch (error) {
                errorMsg.textContent = error.message || 'Verbinding mislukt';
                errorMsg.style.display = 'block';
                connectBtn.disabled = false;
                connectBtn.textContent = 'Verbinden';
            }
        });

        // Send piece
        async function sendPiece(btn) {
            try {
                btn.classList.add('success');
                await RemoteControl.sendPiece();

                setTimeout(() => {
                    btn.classList.remove('success');
                }, 500);
            } catch (error) {
                alert('Verzenden mislukt: ' + error.message);
            }
        }

        pieceBtn.addEventListener('click', () => sendPiece(pieceBtn));

        // Navigation buttons
        document.getElementById('show-tasks-btn').addEventListener('click', () => {
            showScreen(tasksScreen);
        });

        document.getElementById('show-settings-btn').addEventListener('click', () => {
            showScreen(settingsScreen);
        });

        document.getElementById('show-library-btn').addEventListener('click', () => {
            showScreen(libraryScreen);
            populatePuzzleGrid();
            renderPhotoLibrary();
        });

        // Back buttons
        document.getElementById('tasks-back-btn').addEventListener('click', () => {
            showScreen(connectedScreen);
        });

        document.getElementById('settings-back-btn').addEventListener('click', () => {
            showScreen(connectedScreen);
        });

        document.getElementById('library-back-btn').addEventListener('click', () => {
            showScreen(connectedScreen);
        });

        // Library tabs
        document.querySelectorAll('.library-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.library-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById('presets-tab').style.display = tabName === 'presets' ? 'block' : 'none';
                document.getElementById('photos-tab').style.display = tabName === 'photos' ? 'block' : 'none';
            });
        });

        // === SETTINGS STATE (temporary until saved) ===
        let pendingSettings = {};

        // Piece count
        document.getElementById('piece-count').addEventListener('change', (e) => {
            pendingSettings.pieceCount = parseInt(e.target.value);
        });

        // Puzzle mode (auto/manual)
        document.getElementById('puzzle-mode').addEventListener('change', (e) => {
            pendingSettings.puzzleMode = e.target.value;
        });

        // Vehicle grid (mini buttons)
        document.querySelectorAll('.vehicle-btn-mini').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.vehicle-btn-mini').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                pendingSettings.vehicle = btn.dataset.vehicle;
            });
        });

        // Color grid for background (mini buttons)
        document.querySelectorAll('.color-btn-mini').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn-mini').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                pendingSettings.bgColor = btn.dataset.color;
            });
        });

        // Timer stepper buttons
        let timerValue = 15;
        document.getElementById('timer-minus').addEventListener('click', () => {
            if (timerValue > 1) {
                timerValue--;
                document.getElementById('timer-value').textContent = timerValue;
                pendingSettings.timerInterval = timerValue;
            }
        });
        document.getElementById('timer-plus').addEventListener('click', () => {
            if (timerValue < 60) {
                timerValue++;
                document.getElementById('timer-value').textContent = timerValue;
                pendingSettings.timerInterval = timerValue;
            }
        });

        // Pause button (now on main screen)
        document.getElementById('pause-btn').addEventListener('click', async (e) => {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            btn.querySelector('.icon').textContent = isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            btn.querySelector('.label').textContent = isPaused ? 'Doorgaan' : 'Pauze';
            btn.classList.toggle('active', isPaused);
            await sendSettings({ timerPaused: isPaused });
        });

        // Save button - saves all pending settings and goes back
        document.getElementById('settings-save-btn').addEventListener('click', async () => {
            if (Object.keys(pendingSettings).length > 0) {
                await sendSettings(pendingSettings);
                pendingSettings = {};
            }
            showScreen(connectedScreen);
        });

        // Back button - discards changes and goes back
        document.getElementById('settings-back-btn').addEventListener('click', () => {
            pendingSettings = {};
            showScreen(connectedScreen);
        });

        // === PUZZLE PREVIEW SYSTEM ===
        let previewInterval = null;
        let lastPuzzleState = null;

        // Start listening for puzzle state updates
        function startPuzzlePreview() {
            if (previewInterval) clearInterval(previewInterval);

            previewInterval = setInterval(() => {
                if (RemoteControl.roomRef) {
                    RemoteControl.roomRef.child('puzzleState').once('value', (snapshot) => {
                        const state = snapshot.val();
                        if (state) {
                            updatePuzzlePreview(state);
                        }
                    });
                }
            }, 1000);
        }

        function stopPuzzlePreview() {
            if (previewInterval) {
                clearInterval(previewInterval);
                previewInterval = null;
            }
        }

        // Update the preview display
        function updatePuzzlePreview(state) {
            const { puzzleIndex, piecesPlaced, totalPieces, isComplete, imageData } = state;

            // Update progress text
            document.getElementById('preview-progress-text').textContent =
                `${piecesPlaced}/${totalPieces}`;

            // Update progress bar
            const percent = totalPieces > 0 ? (piecesPlaced / totalPieces) * 100 : 0;
            document.getElementById('preview-progress-fill').style.width = `${percent}%`;

            // Update preview image
            if (imageData) {
                document.getElementById('preview-img').src = imageData;
            }

            // Show/hide completion badge
            const badge = document.getElementById('puzzle-complete-badge');
            if (isComplete) {
                badge.style.display = 'block';
                // Vibrate if supported
                if (navigator.vibrate && lastPuzzleState && !lastPuzzleState.isComplete) {
                    navigator.vibrate([200, 100, 200]);
                }
            } else {
                badge.style.display = 'none';
            }

            lastPuzzleState = state;
        }

        // Start preview when connected
        const originalConnectHandler = connectBtn.onclick;
        connectBtn.addEventListener('click', async () => {
            // Start preview after successful connection
            setTimeout(() => {
                if (connectedScreen.style.display === 'block') {
                    startPuzzlePreview();
                }
            }, 500);
        });

        // === PHOTO LIBRARY SYSTEM ===
        let pendingPhotoData = null;
        let selectedLibraryPhotoId = null;

        // Render photo library grid
        function renderPhotoLibrary() {
            const library = StorageManager.getPhotoLibrary();
            const grid = document.getElementById('photo-grid');
            const emptyMsg = document.getElementById('empty-library');
            const countEl = document.getElementById('library-count');
            const useBtn = document.getElementById('use-selected-btn');

            countEl.textContent = `${library.length} foto's`;

            if (library.length === 0) {
                grid.style.display = 'none';
                emptyMsg.style.display = 'block';
                useBtn.disabled = true;
                return;
            }

            grid.style.display = 'grid';
            emptyMsg.style.display = 'none';

            grid.innerHTML = library.map(photo => `
                <div class="photo-item ${selectedLibraryPhotoId === photo.id ? 'selected' : ''}" data-id="${photo.id}">
                    <img src="${photo.data}" alt="${photo.name}">
                    <div class="photo-name">${photo.name}</div>
                    <button class="delete-photo" data-id="${photo.id}">‚úï</button>
                </div>
            `).join('');

            // Add click handlers for selection
            grid.querySelectorAll('.photo-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-photo')) return;
                    const id = item.dataset.id;
                    selectedLibraryPhotoId = (selectedLibraryPhotoId === id) ? null : id;
                    renderPhotoLibrary();
                });
            });

            // Add click handlers for delete buttons
            grid.querySelectorAll('.delete-photo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    if (confirm('Weet je zeker dat je deze foto wilt verwijderen?')) {
                        StorageManager.removePhoto(id);
                        if (selectedLibraryPhotoId === id) {
                            selectedLibraryPhotoId = null;
                        }
                        renderPhotoLibrary();
                    }
                });
            });

            useBtn.disabled = !selectedLibraryPhotoId;
        }

        // === INTERACTIVE CROP SYSTEM ===
        let originalImage = null;  // Original image element
        let cropState = {
            x: 0,
            y: 0,
            width: 0,
            height: 0,
            isDragging: false,
            startX: 0,
            startY: 0
        };

        const TARGET_RATIO = 8 / 5;  // Puzzle aspect ratio

        // Initialize crop box based on image dimensions
        function initCropBox() {
            const cropArea = document.getElementById('crop-area');
            const cropBox = document.getElementById('crop-box');
            const preview = document.getElementById('photo-preview');

            const areaWidth = cropArea.offsetWidth;
            const areaHeight = cropArea.offsetHeight;
            const areaRatio = areaWidth / areaHeight;

            // Calculate crop box size (as large as possible with 8:5 ratio)
            let boxWidth, boxHeight;
            if (areaRatio > TARGET_RATIO) {
                // Area is wider than target - height is limiting factor
                boxHeight = areaHeight * 0.9;
                boxWidth = boxHeight * TARGET_RATIO;
            } else {
                // Area is taller than target - width is limiting factor
                boxWidth = areaWidth * 0.9;
                boxHeight = boxWidth / TARGET_RATIO;
            }

            // Center the crop box
            cropState.width = boxWidth;
            cropState.height = boxHeight;
            cropState.x = (areaWidth - boxWidth) / 2;
            cropState.y = (areaHeight - boxHeight) / 2;

            updateCropBox();
        }

        // Update crop box position/size
        function updateCropBox() {
            const cropBox = document.getElementById('crop-box');
            cropBox.style.left = cropState.x + 'px';
            cropBox.style.top = cropState.y + 'px';
            cropBox.style.width = cropState.width + 'px';
            cropBox.style.height = cropState.height + 'px';
        }

        // Constrain crop box to image bounds
        function constrainCropBox() {
            const cropArea = document.getElementById('crop-area');
            const maxX = cropArea.offsetWidth - cropState.width;
            const maxY = cropArea.offsetHeight - cropState.height;

            cropState.x = Math.max(0, Math.min(cropState.x, maxX));
            cropState.y = Math.max(0, Math.min(cropState.y, maxY));
        }

        // Handle drag start
        function onCropDragStart(e) {
            e.preventDefault();
            cropState.isDragging = true;
            const touch = e.touches ? e.touches[0] : e;
            cropState.startX = touch.clientX - cropState.x;
            cropState.startY = touch.clientY - cropState.y;
        }

        // Handle drag move
        function onCropDragMove(e) {
            if (!cropState.isDragging) return;
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            cropState.x = touch.clientX - cropState.startX;
            cropState.y = touch.clientY - cropState.startY;
            constrainCropBox();
            updateCropBox();
        }

        // Handle drag end
        function onCropDragEnd() {
            cropState.isDragging = false;
        }

        // Setup crop box event listeners
        function setupCropEvents() {
            const cropBox = document.getElementById('crop-box');

            // Mouse events
            cropBox.addEventListener('mousedown', onCropDragStart);
            document.addEventListener('mousemove', onCropDragMove);
            document.addEventListener('mouseup', onCropDragEnd);

            // Touch events
            cropBox.addEventListener('touchstart', onCropDragStart, { passive: false });
            document.addEventListener('touchmove', onCropDragMove, { passive: false });
            document.addEventListener('touchend', onCropDragEnd);
        }

        // Get cropped image data
        function getCroppedImage() {
            if (!originalImage) return null;

            const cropArea = document.getElementById('crop-area');
            const preview = document.getElementById('photo-preview');

            // Calculate scale between display size and original image
            const scaleX = originalImage.width / preview.offsetWidth;
            const scaleY = originalImage.height / preview.offsetHeight;

            // Calculate crop coordinates in original image space
            const srcX = cropState.x * scaleX;
            const srcY = cropState.y * scaleY;
            const srcWidth = cropState.width * scaleX;
            const srcHeight = cropState.height * scaleY;

            // Create canvas and draw cropped region
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 500;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(originalImage, srcX, srcY, srcWidth, srcHeight, 0, 0, 800, 500);

            return canvas.toDataURL('image/jpeg', 0.85);
        }

        // Setup crop events once
        setupCropEvents();

        // Add photo button - trigger file input
        document.getElementById('add-photo-btn').addEventListener('click', () => {
            document.getElementById('photo-input').click();
        });

        // Handle file selection
        document.getElementById('photo-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                // Load original image
                originalImage = new Image();
                originalImage.onload = () => {
                    // Show crop modal
                    document.getElementById('photo-preview').src = event.target.result;
                    document.getElementById('photo-crop-modal').style.display = 'flex';

                    // Initialize crop box after image is displayed
                    setTimeout(() => {
                        initCropBox();
                    }, 100);
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);

            // Reset input so same file can be selected again
            e.target.value = '';
        });

        // Cancel adding photo
        document.getElementById('cancel-photo-btn').addEventListener('click', () => {
            pendingPhotoData = null;
            originalImage = null;
            document.getElementById('photo-crop-modal').style.display = 'none';
        });

        // Save photo to library
        document.getElementById('save-to-library-btn').addEventListener('click', () => {
            const croppedData = getCroppedImage();
            if (!croppedData) return;

            const name = prompt('Naam voor deze foto:', `Foto ${StorageManager.getPhotoLibrary().length + 1}`);
            if (name === null) return; // User cancelled

            const photo = StorageManager.addPhoto(croppedData, name || undefined);
            if (photo) {
                originalImage = null;
                document.getElementById('photo-crop-modal').style.display = 'none';
                selectedLibraryPhotoId = photo.id; // Auto-select new photo
                renderPhotoLibrary();
            }
        });

        // Use selected photo as puzzle
        document.getElementById('use-selected-btn').addEventListener('click', async () => {
            if (!selectedLibraryPhotoId) return;

            const photo = StorageManager.getPhoto(selectedLibraryPhotoId);
            if (!photo) return;

            try {
                await sendSettings({ customImage: photo.data });
                alert(`Foto "${photo.name}" wordt nu als puzzel geladen!`);
                showScreen(connectedScreen);
            } catch (error) {
                alert('Fout bij verzenden: ' + error.message);
            }
        });

        // === PUZZLE QUEUE SYSTEM ===
        const QUEUE_STORAGE_KEY = 'roadtrip_puzzle_queue';
        let puzzleQueue = [];
        let addingPuzzleMode = null; // 'standard' or 'photo'

        // Load queue from storage
        function loadQueue() {
            try {
                const saved = localStorage.getItem(QUEUE_STORAGE_KEY);
                puzzleQueue = saved ? JSON.parse(saved) : [];
            } catch (e) {
                puzzleQueue = [];
            }
        }

        // Save queue to storage
        function saveQueue() {
            localStorage.setItem(QUEUE_STORAGE_KEY, JSON.stringify(puzzleQueue));
        }

        // Add item to queue
        function addToQueue(item) {
            puzzleQueue.push(item);
            saveQueue();
            renderQueue();
        }

        // Remove item from queue by index
        function removeFromQueue(index) {
            puzzleQueue.splice(index, 1);
            saveQueue();
            renderQueue();
        }

        // Render the queue list
        function renderQueue() {
            const list = document.getElementById('queue-list');
            const emptyMsg = document.getElementById('queue-empty');
            const countEl = document.getElementById('queue-count');
            const loadNextBtn = document.getElementById('load-next-btn');

            countEl.textContent = puzzleQueue.length;
            loadNextBtn.disabled = puzzleQueue.length === 0;

            if (puzzleQueue.length === 0) {
                list.style.display = 'none';
                emptyMsg.style.display = 'block';
                return;
            }

            list.style.display = 'block';
            emptyMsg.style.display = 'none';

            list.innerHTML = puzzleQueue.map((item, index) => {
                const isPhoto = item.type === 'photo';
                const thumbSrc = isPhoto ? item.data : '';
                const emoji = isPhoto ? 'üì∑' : (puzzleList[item.index]?.emoji || 'üß©');
                const name = isPhoto ? item.name : (puzzleList[item.index]?.name || 'Puzzel');
                const typeLabel = isPhoto ? 'Eigen foto' : 'Standaard puzzel';

                return `
                    <div class="queue-item">
                        <div class="queue-item-number">${index + 1}</div>
                        ${isPhoto
                            ? `<img class="queue-item-thumb" src="${thumbSrc}" alt="${name}">`
                            : `<div class="queue-item-thumb" style="display:flex;align-items:center;justify-content:center;font-size:24px;background:${puzzleList[item.index]?.color || '#ddd'}">${emoji}</div>`
                        }
                        <div class="queue-item-info">
                            <div class="queue-item-name">${emoji} ${name}</div>
                            <div class="queue-item-type">${typeLabel}</div>
                        </div>
                        <button class="queue-item-remove" data-index="${index}">‚úï</button>
                    </div>
                `;
            }).join('');

            // Add remove handlers
            list.querySelectorAll('.queue-item-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.index);
                    removeFromQueue(idx);
                });
            });
        }

        // Update current puzzle name display
        function updateQueueCurrentPuzzle(state) {
            const el = document.getElementById('queue-current-name');
            if (state && state.puzzleIndex !== undefined) {
                const puzzle = puzzleList[state.puzzleIndex];
                if (state.customImage) {
                    el.textContent = 'üì∑ Eigen Foto';
                } else if (puzzle) {
                    el.textContent = `${puzzle.emoji} ${puzzle.name}`;
                } else {
                    el.textContent = '-';
                }
            }
        }

        // Show queue screen
        document.getElementById('show-queue-btn').addEventListener('click', () => {
            loadQueue();
            renderQueue();
            // Update current puzzle from latest state
            if (lastPuzzleState) {
                updateQueueCurrentPuzzle(lastPuzzleState);
            }
            showScreen(queueScreen);
        });

        // Back from queue screen
        document.getElementById('queue-back-btn').addEventListener('click', () => {
            showScreen(connectedScreen);
        });

        // Add standard puzzle to queue - show puzzle selection
        document.getElementById('add-puzzle-to-queue-btn').addEventListener('click', () => {
            addingPuzzleMode = 'queue';
            showScreen(puzzlesScreen);
        });

        // Add photo to queue - show photo library
        document.getElementById('add-photo-to-queue-btn').addEventListener('click', () => {
            addingPuzzleMode = 'queue-photo';
            showScreen(photoScreen);
            renderPhotoLibrary();
        });

        // Load next puzzle from queue
        document.getElementById('load-next-btn').addEventListener('click', async () => {
            if (puzzleQueue.length === 0) return;

            const nextItem = puzzleQueue.shift();
            saveQueue();
            renderQueue();

            try {
                if (nextItem.type === 'photo') {
                    await sendSettings({ customImage: nextItem.data });
                } else {
                    await sendSettings({ changePuzzle: nextItem.index });
                }
            } catch (error) {
                alert('Fout bij laden: ' + error.message);
            }
        });

        // Select puzzle - handles both direct load and queue mode
        async function selectPuzzle(index) {
            if (addingPuzzleMode === 'queue') {
                // Add to queue instead of loading directly
                const puzzle = puzzleList[index];
                addToQueue({
                    type: 'standard',
                    index: index,
                    name: puzzle.name
                });
                addingPuzzleMode = null;
                showScreen(queueScreen);
            } else {
                // Normal behavior - load puzzle directly
                try {
                    await sendSettings({ changePuzzle: index });
                    showScreen(connectedScreen);
                } catch (error) {
                    alert('Fout: ' + error.message);
                }
            }
        }

        // Modify use-selected-btn to handle queue mode
        const useSelectedBtn = document.getElementById('use-selected-btn');
        const originalUseHandler = useSelectedBtn.onclick;
        useSelectedBtn.addEventListener('click', async (e) => {
            if (addingPuzzleMode === 'queue-photo') {
                e.stopImmediatePropagation();
                if (!selectedLibraryPhotoId) return;

                const photo = StorageManager.getPhoto(selectedLibraryPhotoId);
                if (!photo) return;

                addToQueue({
                    type: 'photo',
                    data: photo.data,
                    name: photo.name,
                    photoId: photo.id
                });
                addingPuzzleMode = null;
                showScreen(queueScreen);
                return false;
            }
        }, true); // Use capture to intercept first

        // === AGE-BASED TASK PRESETS & TASK MANAGEMENT ===
        const TASK_SETTINGS_KEY = 'roadtrip_task_settings';

        // Default tasks per age group (which tasks are enabled)
        const agePresets = {
            1: {
                // 1 year: Simple sounds, basic movement, easy spotting
                enabled: [
                    "üéµ Een liedje gezongen", "üëè In de handen geklapt", "üêÆ Koe-geluid gemaakt",
                    "üê∂ Hond-geluid gemaakt", "üê± Kat-geluid gemaakt", "ü¶Ü Eend-geluid gemaakt",
                    "üöó Rode auto gezien", "üöô Blauwe auto gezien", "üêÑ Koe gezien", "üêë Schaap gezien",
                    "üëã Gezwaaid naar iemand", "üëç Duimpje omhoog gedaan", "‚úã High five gegeven", "ü§ó Knuffel gegeven",
                    "üßÉ Lekker gedronken", "üç™ Koekje gegeten", "üçå Banaan gegeten",
                    "üòä Lief gelachen", "üò¥ Even gerust", "üß∏ Met knuffel gespeeld"
                ]
            },
            2: {
                // 2 years: All basic tasks (default)
                enabled: null // null means all enabled
            },
            3: {
                // 3 years: Add counting, colors, shapes
                enabled: null,
                extra: [
                    "üî¢ Tot 5 geteld", "üî∑ Een vorm genoemd", "üé® 3 kleuren opgenoemd"
                ]
            },
            4: {
                // 4 years: More challenge
                enabled: null,
                extra: [
                    "üìñ Een letter herkend", "üî¢ Tot 10 geteld", "üéµ Een rijmpje opgezegd",
                    "üî§ Eigen naam gespeld"
                ]
            },
            5: {
                // 5+ years: Full challenge
                enabled: null,
                extra: [
                    "üìñ Een woord gelezen", "üî¢ Tot 20 geteld", "üßÆ Een simpele som gemaakt",
                    "üó£Ô∏è Een verhaal verteld", "üéØ Alle kleuren van de regenboog genoemd",
                    "üìù Iets opgeschreven"
                ]
            }
        };

        // Load task settings from storage
        function loadTaskSettings() {
            try {
                const saved = localStorage.getItem(TASK_SETTINGS_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading task settings:', e);
            }
            return {
                age: 2,
                disabledTasks: [],
                customTasks: []
            };
        }

        // Save task settings to storage
        function saveTaskSettings(settings) {
            localStorage.setItem(TASK_SETTINGS_KEY, JSON.stringify(settings));
        }

        // Get active tasks based on settings
        function getActiveTasks() {
            const settings = loadTaskSettings();
            const activeTasks = {};

            // Start with base remoteTasks
            for (const [category, tasks] of Object.entries(remoteTasks)) {
                activeTasks[category] = tasks.filter(task =>
                    !settings.disabledTasks.includes(task)
                );
            }

            // Add custom tasks
            for (const customTask of settings.customTasks) {
                if (!activeTasks[customTask.category]) {
                    activeTasks[customTask.category] = [];
                }
                activeTasks[customTask.category].push(customTask.text);
            }

            // Add age-specific extra tasks
            const preset = agePresets[settings.age];
            if (preset && preset.extra) {
                // Add extra tasks to appropriate category
                for (const extraTask of preset.extra) {
                    const category = extraTask.startsWith('üî¢') || extraTask.startsWith('üßÆ')
                        ? 'üî¢ Tellen & Leren'
                        : extraTask.startsWith('üìñ') || extraTask.startsWith('üó£Ô∏è')
                        ? 'üòä Braaf Zijn'
                        : 'üéµ Zingen & Geluid';
                    if (!settings.disabledTasks.includes(extraTask)) {
                        if (!activeTasks[category]) activeTasks[category] = [];
                        if (!activeTasks[category].includes(extraTask)) {
                            activeTasks[category].push(extraTask);
                        }
                    }
                }
            }

            return activeTasks;
        }

        // Get all available tasks (for management screen)
        function getAllAvailableTasks() {
            const settings = loadTaskSettings();
            const allTasks = [];

            // Base tasks
            for (const [category, tasks] of Object.entries(remoteTasks)) {
                for (const task of tasks) {
                    allTasks.push({
                        text: task,
                        category: category,
                        enabled: !settings.disabledTasks.includes(task),
                        isCustom: false
                    });
                }
            }

            // Age-specific extra tasks
            const preset = agePresets[settings.age];
            if (preset && preset.extra) {
                for (const task of preset.extra) {
                    allTasks.push({
                        text: task,
                        category: task.startsWith('üî¢') || task.startsWith('üßÆ')
                            ? 'üî¢ Tellen & Leren' : 'üòä Braaf Zijn',
                        enabled: !settings.disabledTasks.includes(task),
                        isCustom: false,
                        isExtra: true
                    });
                }
            }

            // Custom tasks
            for (const customTask of settings.customTasks) {
                allTasks.push({
                    text: customTask.text,
                    category: customTask.category,
                    enabled: true,
                    isCustom: true
                });
            }

            return allTasks;
        }

        // Render task management list
        function renderTaskManageList() {
            const list = document.getElementById('task-manage-list');
            const allTasks = getAllAvailableTasks();
            const settings = loadTaskSettings();

            const enabledCount = allTasks.filter(t => t.enabled).length;
            document.getElementById('active-task-count').textContent = `${enabledCount} actief`;

            // Group by category
            const byCategory = {};
            for (const task of allTasks) {
                if (!byCategory[task.category]) byCategory[task.category] = [];
                byCategory[task.category].push(task);
            }

            list.innerHTML = '';
            for (const [category, tasks] of Object.entries(byCategory)) {
                const catHeader = document.createElement('div');
                catHeader.style.cssText = 'font-weight:bold;font-size:13px;color:#667eea;margin:12px 0 6px 0;';
                catHeader.textContent = category;
                list.appendChild(catHeader);

                for (const task of tasks) {
                    const item = document.createElement('div');
                    item.className = `task-manage-item ${task.enabled ? '' : 'disabled'} ${task.isCustom ? 'custom' : ''}`;
                    item.innerHTML = `
                        <label class="switch task-toggle" style="transform:scale(0.8);">
                            <input type="checkbox" ${task.enabled ? 'checked' : ''} data-task="${task.text.replace(/"/g, '&quot;')}">
                            <span class="slider-toggle"></span>
                        </label>
                        <span class="task-text">${task.text}${task.isExtra ? ' <small style="color:#ff9800">(bonus)</small>' : ''}</span>
                        ${task.isCustom ? `<button class="task-delete" data-task="${task.text.replace(/"/g, '&quot;')}">‚úï</button>` : ''}
                    `;
                    list.appendChild(item);
                }
            }

            // Add toggle handlers
            list.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskText = e.target.dataset.task;
                    const settings = loadTaskSettings();
                    if (e.target.checked) {
                        settings.disabledTasks = settings.disabledTasks.filter(t => t !== taskText);
                    } else {
                        if (!settings.disabledTasks.includes(taskText)) {
                            settings.disabledTasks.push(taskText);
                        }
                    }
                    saveTaskSettings(settings);
                    renderTaskManageList();
                });
            });

            // Add delete handlers for custom tasks
            list.querySelectorAll('.task-delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    const taskText = btn.dataset.task;
                    if (confirm(`"${taskText}" verwijderen?`)) {
                        const settings = loadTaskSettings();
                        settings.customTasks = settings.customTasks.filter(t => t.text !== taskText);
                        saveTaskSettings(settings);
                        renderTaskManageList();
                    }
                });
            });
        }

        // Update populateTaskCategories to use active tasks
        const originalPopulateTaskCategories = populateTaskCategories;
        function populateTaskCategories() {
            const container = document.getElementById('task-categories');
            container.innerHTML = '';

            const activeTasks = getActiveTasks();

            for (const [categoryName, tasks] of Object.entries(activeTasks)) {
                if (tasks.length === 0) continue;

                const categoryId = categoryName.replace(/\s/g, '_');
                completedTasks[categoryId] = completedTasks[categoryId] || new Set();

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.id = `cat-${categoryId}`;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.innerHTML = `
                    <span>${categoryName}</span>
                    <span>
                        <span class="category-count" id="count-${categoryId}">${completedTasks[categoryId].size}/${tasks.length}</span>
                        <span class="toggle-icon">‚ñº</span>
                    </span>
                `;

                const tasksDiv = document.createElement('div');
                tasksDiv.className = 'category-tasks';
                tasksDiv.id = `tasks-${categoryId}`;

                tasks.forEach((task, index) => {
                    const taskId = `${categoryId}-${index}`;
                    const isCompleted = completedTasks[categoryId].has(index);

                    const taskBtn = document.createElement('button');
                    taskBtn.className = `task-item${isCompleted ? ' completed' : ''}`;
                    taskBtn.id = taskId;
                    taskBtn.innerHTML = `
                        <span class="task-checkbox">${isCompleted ? '‚úì' : ''}</span>
                        <span class="task-text">${task}</span>
                    `;
                    taskBtn.addEventListener('click', () => toggleTask(taskBtn, categoryId, index, tasks.length));
                    tasksDiv.appendChild(taskBtn);
                });

                headerDiv.addEventListener('click', () => {
                    categoryDiv.classList.toggle('open');
                });

                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(tasksDiv);
                container.appendChild(categoryDiv);
            }

            const firstCategory = container.querySelector('.category');
            if (firstCategory) firstCategory.classList.add('open');
        }

        // Age selector handler (now using select dropdown)
        document.getElementById('age-select').addEventListener('change', (e) => {
            const age = parseInt(e.target.value);
            const settings = loadTaskSettings();
            settings.age = age;

            // Also send age to tablet for snap tolerance
            pendingSettings.age = age;

            // Apply age preset if needed (for age 1, restrict tasks)
            const preset = agePresets[age];
            if (preset && preset.enabled) {
                // Disable tasks not in the preset
                const allBaseTasks = [];
                for (const tasks of Object.values(remoteTasks)) {
                    allBaseTasks.push(...tasks);
                }
                settings.disabledTasks = allBaseTasks.filter(t => !preset.enabled.includes(t));
            } else {
                // Reset disabled tasks for other ages
                settings.disabledTasks = [];
            }

            saveTaskSettings(settings);
        });

        // Initialize age selector from saved settings
        function initAgeSelector() {
            const settings = loadTaskSettings();
            const ageSelect = document.getElementById('age-select');
            if (ageSelect) {
                ageSelect.value = settings.age.toString();
            }
        }

        // Manage tasks button
        document.getElementById('manage-tasks-btn').addEventListener('click', () => {
            renderTaskManageList();
            showScreen(taskManageScreen);
        });

        // Back from task management
        document.getElementById('task-manage-back-btn').addEventListener('click', () => {
            showScreen(settingsScreen);
        });

        // Reset tasks to default for current age
        document.getElementById('reset-tasks-btn').addEventListener('click', () => {
            if (confirm('Alle taken resetten naar standaard voor deze leeftijd?')) {
                const settings = loadTaskSettings();
                settings.disabledTasks = [];

                // Apply age preset
                const preset = agePresets[settings.age];
                if (preset && preset.enabled) {
                    const allBaseTasks = [];
                    for (const tasks of Object.values(remoteTasks)) {
                        allBaseTasks.push(...tasks);
                    }
                    settings.disabledTasks = allBaseTasks.filter(t => !preset.enabled.includes(t));
                }

                saveTaskSettings(settings);
                renderTaskManageList();
            }
        });

        // Add custom task button
        document.getElementById('add-custom-task-btn').addEventListener('click', () => {
            document.getElementById('add-task-modal').classList.add('show');
            document.getElementById('new-task-input').value = '';
            document.getElementById('new-task-input').focus();
        });

        // Cancel add task
        document.getElementById('cancel-new-task').addEventListener('click', () => {
            document.getElementById('add-task-modal').classList.remove('show');
        });

        // Save new task
        document.getElementById('save-new-task').addEventListener('click', () => {
            const text = document.getElementById('new-task-input').value.trim();
            const category = document.getElementById('new-task-category').value;

            if (!text) {
                alert('Voer een taakomschrijving in');
                return;
            }

            const settings = loadTaskSettings();
            settings.customTasks.push({ text, category });
            saveTaskSettings(settings);

            document.getElementById('add-task-modal').classList.remove('show');
            renderTaskManageList();
        });

        // Close modal on backdrop click
        document.getElementById('add-task-modal').addEventListener('click', (e) => {
            if (e.target.id === 'add-task-modal') {
                document.getElementById('add-task-modal').classList.remove('show');
            }
        });

        // Initialize age selector on load
        initAgeSelector();

        // === TUTORIAL SYSTEM ===
        const TUTORIAL_SHOWN_KEY = 'roadtrip_tutorial_shown';

        const tutorialSteps = [
            {
                icon: 'üëã',
                title: 'Welkom bij Puzzel Remote!',
                text: 'Met deze app bedien je de puzzel op de tablet van je kind. We leggen even uit hoe alles werkt.'
            },
            {
                icon: 'üîó',
                title: 'Stap 1: Verbinden',
                text: 'Voer de 4-cijferige code in die je ziet op de tablet. Zo weet de app welke tablet je bedient.'
            },
            {
                icon: 'üß©',
                title: 'Stap 2: Puzzelstukje geven',
                text: 'De grote oranje knop geeft een puzzelstukje. Je kind verdient stukjes door braaf te zijn of taken te doen!'
            },
            {
                icon: 'üìã',
                title: 'Bucketlist',
                text: 'Tik op taken die je kind heeft gedaan (bijv. "koe gezien"). Leuk om de reis speelser te maken!'
            },
            {
                icon: 'üé®',
                title: 'Puzzels kiezen',
                text: 'Kies uit 25 dierenpuzzels of upload je eigen foto\'s. Je kunt ook een wachtrij maken.'
            },
            {
                icon: '‚öôÔ∏è',
                title: 'Instellingen',
                text: 'Pas de timer aan, kies een voertuig voor de tijdbalk, en stel de achtergrondkleur van de tablet in.'
            },
            {
                icon: '‚è∏Ô∏è',
                title: 'Pauze & Opnieuw',
                text: 'Pauze stopt de timer (handig bij een stop). "Opnieuw" start de huidige puzzel helemaal opnieuw.'
            },
            {
                icon: 'üéâ',
                title: 'Klaar!',
                text: 'Je weet nu alles! Veel plezier onderweg. Je kunt deze uitleg altijd opnieuw bekijken via Instellingen.'
            }
        ];

        let currentTutorialStep = 0;

        function showTutorial() {
            currentTutorialStep = 0;
            updateTutorialUI();
            document.getElementById('tutorial-overlay').classList.add('show');
        }

        function hideTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('show');
            localStorage.setItem(TUTORIAL_SHOWN_KEY, 'true');
        }

        function updateTutorialUI() {
            const step = tutorialSteps[currentTutorialStep];
            document.getElementById('tutorial-icon').textContent = step.icon;
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-text').textContent = step.text;

            // Update progress dots
            const progressContainer = document.getElementById('tutorial-progress');
            progressContainer.innerHTML = tutorialSteps.map((_, i) =>
                `<div class="tutorial-dot${i === currentTutorialStep ? ' active' : ''}"></div>`
            ).join('');

            // Update button text
            const nextBtn = document.getElementById('tutorial-next');
            if (currentTutorialStep === tutorialSteps.length - 1) {
                nextBtn.textContent = 'Klaar!';
            } else {
                nextBtn.textContent = 'Volgende';
            }
        }

        document.getElementById('tutorial-next').addEventListener('click', () => {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                updateTutorialUI();
            } else {
                hideTutorial();
            }
        });

        document.getElementById('tutorial-skip').addEventListener('click', () => {
            hideTutorial();
        });

        // Tutorial button in settings
        document.getElementById('start-tutorial-btn').addEventListener('click', () => {
            showScreen(connectedScreen);
            setTimeout(() => showTutorial(), 300);
        });

        // Show tutorial on first visit (after connecting)
        function maybeShowTutorialOnConnect() {
            if (!localStorage.getItem(TUTORIAL_SHOWN_KEY)) {
                setTimeout(() => showTutorial(), 500);
            }
        }

        // Hook into connect success - show tutorial after first connection
        connectBtn.addEventListener('click', () => {
            // Wait a bit for connection, then check if we should show tutorial
            setTimeout(() => {
                if (connectedScreen.style.display !== 'none') {
                    maybeShowTutorialOnConnect();
                }
            }, 1500);
        });

        // Focus first digit on load and check if any digits are pre-filled
        digits[0].focus();
        updateConnectButton();
    </script>
</body>
</html>
